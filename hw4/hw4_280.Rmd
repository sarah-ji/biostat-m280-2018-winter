---
title: "hw4_280"
author: "Sarah Ji"
date: "3/6/2018"
output: html_document
---

```{r setup, include=FALSE}
#http://35.185.198.142:8787/
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(sparklyr)
library(dplyr)
library(ggplot2)
# these are packages you will need, but probably already have.
# Don't bother installing if you already have them
#install.packages(c("ggplot2", "devtools", "dplyr", "stringr"))

# some standard map packages.
#install.packages(c("maps", "mapdata"))

# the github version of ggmap, which recently pulled in a small fix I had
# for a bug 
devtools::install_github("dkahle/ggmap")
p_load("sparklyr", "dplyr", "ggplot2", "ggmap", "maps", "mapdata", "haven", "ggrepel", "pacman")
```

```{r}
usa = map_data("usa")
world = map_data("world")
```


```{r}
Sys.setenv(SPARK_HOME="/usr/lib/spark")
config <- spark_config()
sc <- spark_connect(master = "local", config = config)
```

Access hive tables
```{r}
# Cache flights Hive table into Spark
#tbl_cache(sc, 'flights')
flights_tbl <- tbl(sc, 'flights')

#show what columns I have lazily
#flights_tbl %>% print(width = Inf)
```

```{r}
# Cache airlines Hive table into Spark
#tbl_cache(sc, 'airlines')
airlines_tbl <- tbl(sc, 'airlines')
#airlines_tbl %>% print(width = Inf)
```

```{r}
# Cache airports Hive table into Spark
#tbl_cache(sc, 'airports')
airports_tbl <- tbl(sc, 'airports')
#airports_tbl %>% print(width = Inf)
```

Map the top 10 busiest airports. Size of dots should reflect the number of flights through that destination.
Hint: You may find this tutorial on Making Maps in R helpful.

```{r}
#flightzz <- flights_tbl %>% select(year, uniquecarrier, flightnum, origin, dest, cancelled) %>% collect()


flightzdest = flights_tbl %>% filter(cancelled == 0) %>% select(origin, dest) %>%
group_by(dest) %>% summarise(n_dest = count()) %>%
arrange(desc(n_dest)) %>% collect()

flightzorigin = flights_tbl %>% filter(cancelled==0) %>% select(origin, dest) %>%
group_by(origin) %>% summarise(n_origin = count()) %>%
arrange(desc(n_origin)) %>% collect() 

flightstotal = left_join(flightzorigin, flightzdest, by = c("origin" = "dest")) %>% mutate(N = (n_origin + n_dest)/1000000) %>% arrange(desc(N))

names(flightstotal) = c("Airport", "n_origin", "n_dest", "Total Flights (in millions)")
top10busiestAirports = flightstotal$Airport[1:10]

```

```{r}

top10busiestLatLong = airportz %>% 
filter(faa %in% top10busiestAirports) %>% 
select(AirportID = faa, Airport = name, Latitude = lat, Longitude = lon) %>% collect()

top10busiestLatLong2 = left_join(flightstotal, top10busiestLatLong, by = c("Airport" = "AirportID")) %>% filter(!is.na(Latitude)) %>% mutate(Latitude = as.numeric(Latitude), Longitude = as.numeric(Longitude))
```

```{r}
ggplot() + 
      geom_polygon(data = usa, aes(x = long, y = lat), fill = "lavender", color = "blue") + 
      geom_point(data = top10busiestLatLong2, aes(x = Longitude, y = Latitude), color = "black", size = 5) +
      geom_point(data = top10busiestLatLong2, aes(x = Longitude, y = Latitude), color = "chartreuse", size = 4) +
      coord_fixed(1.3)
```


```{r}
states = map_data("state")
ggplot() + 
      geom_polygon(data = states, aes(x = long, y = lat, fill = region, group = group), color = "white") + 
      geom_point(data = top10busiestLatLong2, aes(x = Longitude, y = Latitude, size = `Total Flights (in millions)`), color = "black") +
      geom_point(data = top10busiestLatLong2, aes(x = Longitude, y = Latitude, size = `Total Flights (in millions)`), color = "chartreuse") +
      #geom_text(aes(x = Longitude, y = Latitude, label = as.character(top10busiestAirports)), check_overlap = TRUE) +
      scale_size(name = "Total Flights (in millions)", range = c(1, 5)) +
      labs(x = "Longitude", y = "Latitude", title = "Top 10 Busiest Airports in USA") +
      coord_fixed(1.5)

```

2. Map the top 10 busiest direct routes. Size of lines should reflect the number of flights through that route.


```{r}
jointpath = flights_tbl %>% filter(cancelled==0 & !is.na(dest) & !is.na(origin)) %>% 
group_by(dest, origin) %>% summarise(n_jointpath = count()) %>%
arrange(desc(n_jointpath)) %>% collect()

top10traveledpathDestination = jointpath$dest[1:10]
top10traveledpathOrigin = jointpath$origin[1:10]

pathlatitudelongitude = airports_tbl %>% 
filter(faa %in% c(top10traveledpathDestination, top10traveledpathOrigin)) %>% 
select(Airport = faa, Latitude = lat, Longitude = lon) %>% collect()

top10busiestpath = jointpath[1:10, ] 
top10busiestpath$pairnumber = c(1:10)

top10buspathwithlatlong1 = left_join(top10busiestpath, pathlatitudelongitude, by = c("dest" = "Airport"))
top10buspathwithlatlong2 = left_join(top10busiestpath, pathlatitudelongitude, by = c("origin" = "Airport"))

top10busiestpathLL = full_join(top10buspathwithlatlong1, top10buspathwithlatlong2, by = "n_jointpath")
testlong = bind_rows(top10buspathwithlatlong1, top10buspathwithlatlong2)


#top10busiestpathLL = top10busiestpathLL[,-c(7:9)]
#names(top10busiestpathLL) = c("Destination", "Origin", "N_path", "Path", "Lat.D", "Long.D", "Lat.O", "Long.O")


long10busypath = testlong %>%
mutate(Latitudes = as.numeric(Latitude), Longitudes = as.numeric(Longitude)) %>% select(Destination = dest, Origin = origin, N_path = n_jointpath, routenumber = pairnumber, Latitudes, Longitudes)


ggplot() + 
geom_polygon(data = states, 
aes(x = long, y = lat, group = group, fill = region), color = "white") +
coord_fixed(1.3) + 
geom_point(data = long10busypath, aes(x = Longitudes, y = Latitudes), color = "black") + 
geom_curve(data = top10busiestpathLL, aes(x = as.numeric(Longitude.x), y = as.numeric(Latitude.x), xend = as.numeric(Longitude.y), yend = as.numeric(Latitude.y))) +
labs(title = "Map of Top 10 Busiest Routes", 
x = "Longitude (Degrees)", y = "Latitude (Degrees)") 

+ geom_label_repel(data = long10busypath,  aes(x = Longitudes, y = Latitudes), label = long10busypath$Destination)

#add both ways to make 10 different routes

#write.csv(file = "~/biostat-m280-2018-winter/hw4/top10busiestpaths.csv", long10busypath, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/top10busiestAirports.csv", top10busiestLatLong2, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/LAXflightsbyday", LAXflightsbyday, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/completetoppath.csv", jointpath, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/airlines.csv", airlinez, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/airports.csv", airportz, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/weekdaysLAX.csv", LAX2, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/airports.csv", airportz, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/modeldataHua.csv", model_data, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/modeldataME.csv", my_model_data, row.names = FALSE) 

```

3. 
(a). Reproduce above plot. Visualize and explain some prominent features you observe. For example, what happened at points 1-5?

  

```{r}
LAXflightsbyday = flights_tbl %>% 
  filter(cancelled == 0 & (origin == "LAX" | dest == "LAX") & year >= 1998) %>%
group_by(year, month, dayofmonth) %>% summarise(n = count()) %>% collect()

LAXflightsbyday %>% arrange(year, month, dayofmonth) %>% mutate(date = make_date(year = year, month = month, day = dayofmonth)) %>% ggplot() + geom_line(aes(x = date, y = n)) + coord_cartesian(ylim = c(800, 1400)) + labs(title = "LAX air traffic")

```

 # potential dates at the 5 points and the counts
    # 3 2004-07-04 1060
    # 2 2004-11-25 1019
    # 5 2001-01-01 1299
    # 1 2001-10-01 1076
    # 4 2008-01-01 1292

**Answer**:
Airport operational issues
Airport traffic volume
Staffing issues like information about air carrier crew
Aircraft mechanical issues
Historical data on conferences or events that can indirectly impact flight performance
Passenger traffic by airport by day etc

"It's not going to be a revolution; it's going to be an evolution," said Bob van der Linden, chairman of the aeronautics division at the Smithsonian's National Air and Space Museum. 

"It's almost like the A380 was specifically designed for Los Angeles," said Allan McArtor, chairman of Airbus North America. "Los Angeles is an airport that is constrained by its boundaries — in a community that is very environmentally sensitive to both emissions and noise — and there's a need to be more efficient with respect to aircraft movements."

Qantas Airways, scheduled to make it's first commercial A380 flight into LAX in August 2008. The super jumbo jet also could help space-constrained airports, including LAX, by allowing carriers to combine several flights into one.

In Los Angeles, Airbus and many of the 15 international carriers that have purchased the behemoth repeatedly have criticized LAX for moving too slowly to improve its facilities. A380's first U.S. landing

Los Angeles World Airports expects to spend about $121 million by 2009 to ready the airport for the A380, which carries at least 140 more passengers than a Boeing 747, currently the largest passenger jet in service. Despite the upgrades to LAX, carriers are still concerned that the airport won't have enough gates to support multiple A380 flights. By 2010, LAX is expected to handle more A380 operations than any airport in North America.

Boeing 747-400ER 

Passengers*: 416

Airbus A380

Passengers*: 555

http://www.latimes.com/travel/la-trw-airbus18mar18-story.html

At the moment - 2005 - the recorded increase is 4-5 % yearly and this means some  60% additional traffic around 2015 in the skies, for a system working already at maximum capacity


August 8,2000	LAX Lighting Ceremony for pylons. New Gateway to Southern California

April 2,2007	Newly relocated Runway 25 Left/7 Right on the south side of the airport reopens to air traffic. Completion was a major milestone in an overall $333-million South Airfield Improvement Project

https://www.lawa.org/en/history/lax-history/just-the-facts 

It is illegal to limit the number of passengers that use an airport, but in December 2005 the city agreed to limit the passenger gates to 163.  Once passenger usage hits 75 million, a maximum of two gates a year for up to five years will be closed, intending to limit growth to 79 million passengers a year. In exchange civil lawsuits were abandoned, to allow the city to complete badly needed improvements to the airport.

A key element of the settlement proposal involves limiting passenger traffic at LAX, which is expected to hit 63 million this year.

The FAA does not allow airports to cap the number of passengers, but Kennard said LAX can be designed to limit growth. Once annual passenger traffic hits 75 million, the airport would shut down two gates a year for the next five years.

That would reduce the number of airport gates from the current 163 to 153, limiting the number of flights that could be accommodated.

https://web.archive.org/web/20100722070218/http://www.redorbit.com/news/technology/318661/deal_cut_to_halt_los_angeles_airport_lawsuits/

2004 - https://www.lawa.org/-/media/lawa-web/lawa-our-lax/finallaxplan_092904.ashx
provide and upgrade needed facilities to accomodate current and next generation larger aircraft associated with internationa and long haul domestic travel. september 29 2004.

NEWLY EXPANDED AND RENOVATED BOB HOPE HOLLYWOOD USO CENTER TO BE RE-DEDICATED AT LOS ANGELES INTERNATIONAL AIRPORT
09/24/2004

(Los Angeles, California, September 4, 2004) -- Los Angeles International Airport returned to normal Saturday after two unrelated incidents resulted in four of the nine passenger terminals being closed and vehicle traffic restricted for about three hours. Neither incident was terrorism-related.

https://www.flylax.com/en/lax-news?page=123 


(b). Visualize and explain seasonal effects.

```{r}

LAXseason1 = flights_tbl %>% 
  filter(cancelled == 0 & (origin == "LAX" | dest == "LAX") & year >= 1998) %>% group_by(year, month) %>% summarise(peryearmonth = count()) %>% collect()

LAXseason2 = LAXseason1 %>%
      mutate(season = as_factor(labelled(month,
                                      c("Winter" = 12, "Winter" = 1, "Winter" = 2,
                                        "Spring" = 3, "Spring" = 4, "Spring" = 5,
                                        "Summer" = 6, "Summer" = 7, "Summer" = 8,
                                        "Autumn" = 9, "Autumn" = 10, "Autumn" = 11)))) 

LAXseason2 = LAXseason2 %>% group_by(year, season) %>% mutate(n_season = sum(peryearmonth))

    
    LAXseason2 %>% group_by(year) %>% ggplot(aes(x = cut_width(year, 1), y = n_season / 1000000, fill = season)) + 
      geom_bar(stat = "identity") +
      labs(title = "LAX Air Traffic Seasonal Effects",
           x = "Year", y = "Flights (in millions)", fill = "Season") + scale_fill_manual(values = c("lightblue1", "powderblue", "lightblue3", "lightblue4")) + theme_light()

```


(c). Visualize and explain weekly effects.


```{r}
LAXflightsbyweek = flights_tbl %>% 
  filter(cancelled == 0, origin == "LAX" | dest == "LAX", year >= 1998, !is.na(dayofweek)) %>%
group_by(dayofweek) %>% mutate(n_week = count()) %>% select(year, dayofweek, n_week) %>% collect()

LAXweek1 = flights_tbl %>% 
  filter(cancelled == 0 & (origin == "LAX" | dest == "LAX") & year >= 1998 & !is.na(dayofweek)) %>% group_by(year, dayofweek) %>% 
  summarise(peryearday = count()) %>% collect()

LAXweek2 = LAXweek1 %>%
      mutate(Weekday = as_factor(labelled(dayofweek,
                                      c("Monday" = 1, "Tuesday" = 2, "Wednesday" = 3,
                                        "Thursday" = 4, "Friday" = 5, "Saturday" = 6,
                                        "Sunday" = 7)))) 

LAXweek2 = LAXweek2 %>% group_by(year, Weekday) %>% mutate(n_weekday = sum(peryearday))

    
    LAXweek2 %>% ggplot(aes(x = cut_width(year, 1), y = n_weekday / 1000000, fill = Weekday)) + 
      geom_bar(stat = "identity") +
      labs(title = "LAX Air Traffic Weekly Effects",
           x = "Year", y = "Flights (in millions)", fill = "Weekday") + scale_fill_manual(values = c("#882E72", "#B178A6", "#D6C1DE", "#1965B0", "#5289C7", "#7BAFDE", "#4EB265", "#90C987", "#CAE0AB", "#F7EE55", "#F6C141", "#F1932D", "#E8601C", "#DC050C")) + theme_light()
```


(d). Map top 10 destinations from LAX. Size of dots should reflect the number of flights from LAX to that destination.


```{r}
fromLAX = flights_tbl %>% 
  filter(cancelled == 0, origin == "LAX", year >= 1998) %>%
group_by(dest) %>% summarise(n_fromLAX = count()) %>% collect()

top10destfromLAXnames = fromLAX$dest[1:10]
top10destfromLAX = fromLAX[1:10,]
```

```{r}
top10destLAXLatLong = airportz %>% 
filter(faa %in% top10destfromLAXnames) %>% 
select(AirportID = faa, Airport = name, Latitude = lat, Longitude = lon) %>% collect()

top10fromLaxLatLong2 = left_join(top10destfromLAX, top10destLAXLatLong, by = c("dest" = "AirportID")) %>% filter(!is.na(Latitude)) %>% mutate(Latitude = as.numeric(Latitude), Longitude = as.numeric(Longitude))

states = map_data("state")
ggplot() + 
      geom_polygon(data = states, aes(x = long, y = lat, fill = region, group = group), color = "white") + 
      geom_point(data = top10fromLaxLatLong2, aes(x = Longitude, y = Latitude, size = `n_fromLAX`), color = "black") +
      geom_point(data = top10fromLaxLatLong2, aes(x = Longitude, y = Latitude, size = `n_fromLAX`), color = "chartreuse") +
      #geom_text(aes(x = Longitude, y = Latitude, label = as.character(top10busiestAirports)), check_overlap = TRUE) +
      scale_size(name = "n_fromLAX", range = c(1, 5)) +
      labs(x = "Longitude", y = "Latitude", title = "Top 10 Destinations from LAX") +
      coord_fixed(1.5)
```

4. Predictive model for the arrival delay of flights flying from LAX

```{r}

model_data <- flights_tbl %>%
    filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance) & origin == "LAX" & (cancelled == 0)) %>%
    filter(depdelay > 15 & depdelay < 240) %>% #filter outliers
    filter(arrdelay > -60 & arrdelay < 360) %>% #filter outliers
    filter(year >= 2003 & year <= 2007) %>%
    left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>% # merge by the columns
    left_join(airports_tbl, by = c("dest" = "faa")) %>% 
    filter(!is.na(tz_name) & !is.na(alt)) %>%
    select(year, month, arrdelay, depdelay, destination = dest, distance, uniquecarrier, description, tz_name, alt) %>% collect()

model_data = model_data %>% group_by(destination) %>% mutate(n = n())

sumstat_modeldata = 
  model_data %>%
  group_by(uniquecarrier) %>%
  summarize(description = min(description), arrivaldelay = mean(arrdelay), 
            distance = mean(distance), depdelay = mean(depdelay), timezone = min(tz_name), altitude = mean(alt)) %>%
  select(description, arrivaldelay, depdelay, distance, timezone, altitude) %>%
  arrange(arrivaldelay)

write.csv(file = "modeldata.csv", model_data, row.names = F)
```


```{r}
fromLAX3 = flights_tbl %>%
    filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance) & origin == "LAX" & (cancelled == 0)) %>%
    filter(depdelay > 15 & depdelay < 240) %>% #filter outliers
    filter(arrdelay > -60 & arrdelay < 360) %>% #filter outliers
    filter(year >= 2003 & year <= 2007) %>%
    left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>% # merge by the columns
    left_join(airports_tbl, by = c("dest" = "faa")) %>% 
    filter(!is.na(tz_name) & !is.na(alt)) %>%
    select(year, month, arrdelay, depdelay, destination = dest, distance, uniquecarrier, description, tz_name, alt) %>%
group_by(destination) %>% mutate(n_fromLAX = count()) %>% arrange(desc(n_fromLAX))

#fromLAX2 %>% mutate(Busy = as_factor(labelled(n_fromLAX,
 #                                     c(("0-100" %in% c(0:100)),  c(("100-500"%in% c(100:500)),
  #                                                            c(("500-1000" %in% c(600:1000)), c((0 %in% c(0:100)))))) 

```


```{r}
# Partition the data into training and validation sets
model_partition <- fromLAX3 %>% 
  sdf_partition(train = 0.8, valid = 0.2, seed = 5555)

# Fit a linear model

ml1 <- model_partition$train %>%
    ml_linear_regression(arrdelay ~ distance + depdelay + uniquecarrier + tz_name + alt)
  
summary(ml1)

model_partition08 <- data_2008 %>% 
  sdf_partition(train = 0.0, valid = 1.0, seed = 5555)

```

```{r}
  model_deciles <- lapply(model_partition, function(x) {
    sdf_predict(ml1, x) %>%
      mutate(decile = ntile(desc(prediction), 10)) %>%
      group_by(decile) %>%
      summarize(arrdelay = mean(arrdelay)) %>%
      select(decile, arrdelay) %>%
      collect()
  })
```

```{r}
deciles <- rbind(
  data.frame(data = 'train', model_deciles$train),
  data.frame(data = 'valid', model_deciles$valid),
  make.row.names = FALSE
)
```

```{r}
# Plot average gains by predicted decile
deciles %>%
  ggplot(aes(factor(decile), arrdelay, fill = data)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  labs(title = 'Average Arrival Delay by Predicted Decile', x = 'Decile', y = 'Minutes')
```


```{r}
data_2008 = flights_tbl %>%
    filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance) & origin == "LAX" & (cancelled == 0)) %>%
    filter(depdelay > 15 & depdelay < 240) %>% #filter outliers
    filter(arrdelay > -60 & arrdelay < 360) %>% #filter outliers
    filter(year == 2008) %>%
    left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>% # merge by the columns
    left_join(airports_tbl, by = c("dest" = "faa")) %>% 
    filter(!is.na(tz_name) & !is.na(alt)) %>%
    select(year, month, arrdelay, depdelay, destination = dest, distance, uniquecarrier, description, tz_name, alt)

group_by(destination) %>% mutate(n_fromLAX = count()) %>% arrange(desc(n_fromLAX))
```

```{r}
data_2008 
```

```{r}
carrier1 <- sdf_predict(x = data_2008, model = ml1) %>%
  group_by(description) %>% summarize(arrdelay = mean(arrdelay), prediction = mean(prediction), freq = n()) %>% filter(freq > 1000) %>% collect()

ucar1 = sdf_predict(ml1, model_partition08$valid) %>%
      group_by(description) %>%
      summarize(arrdelay = mean(arrdelay), prediction = mean(prediction), freq = n()) %>% filter(freq > 1000) %>% collect()
```


```{r}
# Plot actual gains and predicted gains by airline carrier
ggplot(carrier, aes(arrdelay, prediction)) + 
  geom_point(alpha = 0.75, color = 'red', shape = 3) +
  geom_abline(intercept = 0, slope = 1, alpha = 0.15, color = 'blue') +
  geom_text(aes(label = substr(description, 1, 20)), size = 3, alpha = 0.75, vjust = -1) +
  labs(title='Average Arrival Delay Forecast', x = 'Actual', y = 'Predicted')
```


Data starts around 1987 first year may not have complete data. 22 years of data. 

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
out
```

Barplot of the number of data points in each year

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
out %>% ggplot(aes(x = year, y = n)) + geom_col()
```

FIT A MODEL:

Suppose we want to fit a linear regression of gain (depdelay - arrdelay) on distance, departure delay, and carriers using data from 2003-2007.


```{r, evaluate = FALSE, include = FALSE, echo = FALSE}

modeldata = read.csv("modeldata.csv")

modeldata$id <- 1:nrow(modeldata)
train <- modeldata %>% dplyr::sample_frac(.8)
test  <- dplyr::anti_join(modeldata, train, by = 'id')

lmderp = lm(data = train, arrdelay ~ distance + depdelay + uniquecarrier + tz_name + alt)
summary(lmderp)
modelprediction = predict.lm(lmderp)

test$prediction = modelprediction

mutate(decile = ntile(desc(prediction), 10)) %>%
      group_by(decile) %>%
      summarize(gain = mean(gain)) %>%
      select(decile, gain)
```

Assess model performance
Compare the model performance using the validation data.

Apply the model partition separatately on train and test data. 

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Calculate average gains by predicted decile
system.time(
  model_deciles <- lapply(model_partition, function(x) {
    sdf_predict(ml1, x) %>%
      mutate(decile = ntile(desc(prediction), 10)) %>%
      group_by(decile) %>%
      summarize(gain = mean(gain)) %>%
      select(decile, gain) %>%
      collect()
  })
)
```

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
model_deciles
```

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Create a summary dataset for plotting
deciles <- rbind(
  data.frame(data = 'train', model_deciles$train),
  data.frame(data = 'valid', model_deciles$valid),
  make.row.names = FALSE
)
deciles
```

visualize performance of the model it looks good.

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Plot average gains by predicted decile
deciles %>%
  ggplot(aes(factor(decile), gain, fill = data)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  labs(title = 'Average gain by predicted decile', x = 'Decile', y = 'Minutes')
```

Visualize predictions
Compare actual gains to predicted gains for an out of time sample.

new dataset
```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Select data from an out of time sample
data_2008 <- flights_tbl %>%
  filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance)) %>%
  filter(depdelay > 15 & depdelay < 240) %>%
  filter(arrdelay > -60 & arrdelay < 360) %>%
  filter(year == 2008) %>%
  left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>%
  mutate(gain = depdelay - arrdelay) %>%
  select(year, month, arrdelay, depdelay, distance, uniquecarrier, description, gain, origin, dest)
data_2008
```

for each airline plot the predicted vs actual values of gain. southwest and united wait.
delta is good. 

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Plot actual gains and predicted gains by airline carrier
ggplot(carrier, aes(gain, prediction)) + 
  geom_point(alpha = 0.75, color = 'red', shape = 3) +
  geom_abline(intercept = 0, slope = 1, alpha = 0.15, color = 'blue') +
  geom_text(aes(label = substr(description, 1, 20)), size = 3, alpha = 0.75, vjust = -1) +
  labs(title='Average Gains Forecast', x = 'Actual', y = 'Predicted')
```

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
spark_disconnect_all()
```

