---
title: "hw4_280"
author: "Sarah Ji"
date: "3/6/2018"
output: html_document
---

```{r setup, include=FALSE}
#http://35.185.198.142:8787/
knitr::opts_chunk$set(echo = TRUE)
library(sparklyr)
library(dplyr)
library(ggplot2)
# these are packages you will need, but probably already have.
# Don't bother installing if you already have them
#install.packages(c("ggplot2", "devtools", "dplyr", "stringr"))

# some standard map packages.
#install.packages(c("maps", "mapdata"))

# the github version of ggmap, which recently pulled in a small fix I had
# for a bug 
devtools::install_github("dkahle/ggmap")
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
library(haven)
```

```{r}
usa = map_data("usa")
world = map_data("world")
```


```{r}
Sys.setenv(SPARK_HOME="/usr/lib/spark")
config <- spark_config()
sc <- spark_connect(master = "local", config = config)
```

Access hive tables
```{r}
# Cache flights Hive table into Spark
#tbl_cache(sc, 'flights')
flights_tbl <- tbl(sc, 'flights')

#show what columns I have lazily
#flights_tbl %>% print(width = Inf)
```

```{r}
# Cache airlines Hive table into Spark
#tbl_cache(sc, 'airlines')
airlines_tbl <- tbl(sc, 'airlines')
#airlines_tbl %>% print(width = Inf)
```

```{r}
# Cache airports Hive table into Spark
#tbl_cache(sc, 'airports')
airports_tbl <- tbl(sc, 'airports')
#airports_tbl %>% print(width = Inf)
```

Map the top 10 busiest airports. Size of dots should reflect the number of flights through that destination.
Hint: You may find this tutorial on Making Maps in R helpful.

```{r}
#flightzz <- flights_tbl %>% select(year, uniquecarrier, flightnum, origin, dest, cancelled) %>% collect()


flightzdest = flights_tbl %>% filter(cancelled == 0) %>% select(origin, dest) %>%
group_by(dest) %>% summarise(n_dest = count()) %>%
arrange(desc(n_dest)) %>% collect()

flightzorigin = flights_tbl %>% filter(cancelled==0) %>% select(origin, dest) %>%
group_by(origin) %>% summarise(n_origin = count()) %>%
arrange(desc(n_origin)) %>% collect() 

flightstotal = left_join(flightzorigin, flightzdest, by = c("origin" = "dest")) %>% mutate(N = (n_origin + n_dest)/1000000) %>% arrange(desc(N))

names(flightstotal) = c("Airport", "n_origin", "n_dest", "Total Flights (in millions)")
top10busiestAirports = flightstotal$Airport[1:10]

```

```{r}
ggplot() + geom_polygon(data = usa, aes(x = long, y = lat, group = group), fill = "lavender", color = "blue") + 
coord_fixed(1.3) 
```

```{r}

top10busiestLatLong = airportz %>% 
filter(faa %in% top10busiestAirports) %>% 
select(AirportID = faa, Airport = name, Latitude = lat, Longitude = lon) %>% collect()

top10busiestLatLong2 = left_join(flightstotal, top10busiestLatLong, by = c("Airport" = "AirportID")) %>% filter(!is.na(Latitude)) %>% mutate(Latitude = as.numeric(Latitude), Longitude = as.numeric(Longitude))
```

```{r}
ggplot() + 
      geom_polygon(data = usa, aes(x = long, y = lat), fill = "lavender", color = "blue") + 
      geom_point(data = top10busiestLatLong2, aes(x = Longitude, y = Latitude), color = "black", size = 5) +
      geom_point(data = top10busiestLatLong2, aes(x = Longitude, y = Latitude), color = "chartreuse", size = 4) +
      coord_fixed(1.3)
```


```{r}
states = map_data("state")
ggplot() + 
      geom_polygon(data = states, aes(x = long, y = lat, fill = region, group = group), color = "white") + 
      geom_point(data = top10busiestLatLong2, aes(x = Longitude, y = Latitude, size = `Total Flights (in millions)`), color = "black") +
      geom_point(data = top10busiestLatLong2, aes(x = Longitude, y = Latitude, size = `Total Flights (in millions)`), color = "chartreuse") +
      #geom_text(aes(x = Longitude, y = Latitude, label = as.character(top10busiestAirports)), check_overlap = TRUE) +
      scale_size(name = "Total Flights (in millions)", range = c(1, 5)) +
      labs(x = "Longitude", y = "Latitude", title = "Top 10 Busiest Airports in USA") +
      coord_fixed(1.5)

```

2. Map the top 10 busiest direct routes. Size of lines should reflect the number of flights through that route.


```{r}
jointpath = flights_tbl %>% filter(cancelled==0 & !is.na(dest) & !is.na(origin)) %>% 
group_by(dest, origin) %>% summarise(n_jointpath = count()) %>%
arrange(desc(n_jointpath)) %>% collect()

top10traveledpathDestination = jointpath$dest[1:10]
top10traveledpathOrigin = jointpath$origin[1:10]

pathlatitudelongitude = airports_tbl %>% 
filter(faa %in% c(top10traveledpathDestination, top10traveledpathOrigin)) %>% 
select(Airport = faa, Latitude = lat, Longitude = lon) %>% collect()

top10busiestpath = jointpath[1:10, ] 
top10busiestpath$pairnumber = c(1:10)

top10buspathwithlatlong1 = left_join(top10busiestpath, pathlatitudelongitude, by = c("dest" = "Airport"))
top10buspathwithlatlong2 = left_join(top10busiestpath, pathlatitudelongitude, by = c("origin" = "Airport"))

top10busiestpathLL = full_join(top10buspathwithlatlong1, top10buspathwithlatlong2, by = "n_jointpath")
testlong = bind_rows(top10buspathwithlatlong1, top10buspathwithlatlong2)


#top10busiestpathLL = top10busiestpathLL[,-c(7:9)]
#names(top10busiestpathLL) = c("Destination", "Origin", "N_path", "Path", "Lat.D", "Long.D", "Lat.O", "Long.O")


long10busypath = testlong %>%
mutate(Latitudes = as.numeric(Latitude), Longitudes = as.numeric(Longitude)) %>% select(Destination = dest, Origin = origin, N_path = n_jointpath, routenumber = pairnumber, Latitudes, Longitudes)


ggplot() + 
geom_polygon(data = usa, 
aes(x = long, y = lat, group = group), 
fill = "lavender", color = "blue") +
coord_fixed(1.3) + 
geom_point(data = long10busypath, aes(x = Longitudes, y = Latitudes), color = "black") + 
geom_line(data = long10busypath, aes(x = Longitudes, y = Latitudes, group = routenumber, lwd = as.factor(routenumber),
color = as.factor(routenumber)), show.legend = F,
alpha = 0.4) +
labs(title = "Map of Top 10 Busiest Routes", 
x = "Longitude (Degrees)", y = "Latitude (Degrees)")

#add both ways to make 10 different routes

#write.csv(file = "~/biostat-m280-2018-winter/hw4/top10busiestpaths.csv", long10busypath, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/top10busiestAirports.csv", top10busiestLatLong2, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/LAXflightsbyday", LAXflightsbyday, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/completetoppath.csv", jointpath, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/airlines.csv", airlinez, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/airports.csv", airportz, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/weekdaysLAX.csv", LAX2, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/airports.csv", airportz, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/modeldataHua.csv", model_data, row.names = FALSE) 
#write.csv(file = "~/biostat-m280-2018-winter/hw4/modeldataME.csv", my_model_data, row.names = FALSE) 

```

3. 
(a). Reproduce above plot. Visualize and explain some prominent features you observe. For example, what happened at points 1-5?

```{r}
LAXflightsbyday = flights_tbl %>% 
  filter(cancelled == 0 & (origin == "LAX" | dest == "LAX") & year >= 1998) %>%
group_by(year, month, dayofmonth) %>% summarise(n = count()) %>% collect()

LAXflightsbyday %>% arrange(year, month, dayofmonth) %>% mutate(date = make_date(year = year, month = month, day = dayofmonth)) %>% ggplot() + geom_line(aes(x = date, y = n)) + coord_cartesian(ylim = c(800, 1400)) + labs(title = "LAX air traffic")

```


(b). Visualize and explain seasonal effects.

```{r}

LAXseason1 = flights_tbl %>% 
  filter(cancelled == 0 & (origin == "LAX" | dest == "LAX") & year >= 1998) %>% group_by(year, month) %>% summarise(peryearmonth = count()) %>% collect()

LAXseason2 = LAXseason1 %>%
      mutate(season = as_factor(labelled(month,
                                      c("Winter" = 12, "Winter" = 1, "Winter" = 2,
                                        "Spring" = 3, "Spring" = 4, "Spring" = 5,
                                        "Summer" = 6, "Summer" = 7, "Summer" = 8,
                                        "Autumn" = 9, "Autumn" = 10, "Autumn" = 11)))) 

LAXseason2 = LAXseason2 %>% group_by(year, season) %>% mutate(n_season = sum(peryearmonth))

    
    LAXseason2 %>% ggplot(aes(x = year, y = n_season / 1000000, fill = season)) + 
      geom_bar(stat = "identity") +
      labs(title = "LAX Air Traffic Seasonal Effects",
           x = "Year", y = "Flights (in millions)", fill = "Season")

```


(c). Visualize and explain weekly effects.


```{r}
LAXflightsbyweek = flights_tbl %>% 
  filter(cancelled == 0, origin == "LAX" | dest == "LAX", year >= 1998, !is.na(dayofweek)) %>%
group_by(dayofweek) %>% mutate(n_week = count()) %>% select(year, dayofweek, n_week) %>% collect()

LAXweek1 = flights_tbl %>% 
  filter(cancelled == 0 & (origin == "LAX" | dest == "LAX") & year >= 1998 & !is.na(dayofweek)) %>% group_by(year, dayofweek) %>% 
  summarise(peryearday = count()) %>% collect()

LAXweek2 = LAXweek1 %>%
      mutate(Weekday = as_factor(labelled(dayofweek,
                                      c("Monday" = 1, "Tuesday" = 2, "Wednesday" = 3,
                                        "Thursday" = 4, "Friday" = 5, "Saturday" = 6,
                                        "Sunday" = 7)))) 

LAXweek2 = LAXweek2 %>% group_by(year, Weekday) %>% mutate(n_weekday = sum(peryearday))

    
    LAXweek2 %>% ggplot(aes(x = year, y = n_weekday / 1000000, fill = Weekday)) + 
      geom_bar(stat = "identity") +
      labs(title = "LAX Air Traffic Weekly Effects",
           x = "Year", y = "Flights (in millions)", fill = "Weekday")
```


(d). Map top 10 destinations from LAX. Size of dots should reflect the number of flights from LAX to that destination.



```{r}
fromLAX = flights_tbl %>% 
  filter(cancelled == 0, origin == "LAX", year >= 1998) %>%
group_by(dest) %>% summarise(n_fromLAX = count()) %>% collect()

top10destfromLAXnames = fromLAX$dest[1:10]
top10destfromLAX = fromLAX[1:10,]
```

```{r}
top10destLAXLatLong = airportz %>% 
filter(faa %in% top10destfromLAXnames) %>% 
select(AirportID = faa, Airport = name, Latitude = lat, Longitude = lon) %>% collect()

top10fromLaxLatLong2 = left_join(top10destfromLAX, top10destLAXLatLong, by = c("dest" = "AirportID")) %>% filter(!is.na(Latitude)) %>% mutate(Latitude = as.numeric(Latitude), Longitude = as.numeric(Longitude))

states = map_data("state")
ggplot() + 
      geom_polygon(data = states, aes(x = long, y = lat, fill = region, group = group), color = "white") + 
      geom_point(data = top10fromLaxLatLong2, aes(x = Longitude, y = Latitude, size = `n_fromLAX`), color = "black") +
      geom_point(data = top10fromLaxLatLong2, aes(x = Longitude, y = Latitude, size = `n_fromLAX`), color = "chartreuse") +
      #geom_text(aes(x = Longitude, y = Latitude, label = as.character(top10busiestAirports)), check_overlap = TRUE) +
      scale_size(name = "n_fromLAX", range = c(1, 5)) +
      labs(x = "Longitude", y = "Latitude", title = "Top 10 Destinations from LAX") +
      coord_fixed(1.5)
```

4. Predictive model for the arrival delay of flights flying from LAX

```{r}

model_data <- flights_tbl %>%
    filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance) & origin == "LAX" & (cancelled == 0)) %>%
    filter(depdelay > 15 & depdelay < 240) %>% #filter outliers
    filter(arrdelay > -60 & arrdelay < 360) %>% #filter outliers
    filter(year >= 2003 & year <= 2007) %>%
    left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>% # merge by the columns
    left_join(airports_tbl, by = c("dest" = "faa")) %>% 
    select(year, month, arrdelay, depdelay, destination = dest, distance, uniquecarrier, description, tz_name, alt) %>% collect()

sumstat_modeldata = 
  model_data %>%
  group_by(uniquecarrier) %>%
  summarize(description = min(description), gain = mean(gain), 
            distance = mean(distance), depdelay = mean(depdelay)) %>%
  select(description, gain, distance, depdelay) %>%
  arrange(gain)

```


```{r}
# Partition the data into training and validation sets
model_partition <- model_data %>% 
  sdf_partition(train = 0.8, valid = 0.2, seed = 5555)

# Fit a linear model

ml1 <- model_partition$train %>%
    ml_linear_regression(arrdelay ~ distance + depdelay + uniquecarrier + tz_name + alt)
  
summary(ml1)
```

```{r}
model_deciles <- lapply(model_partition, function(x) {
    sdf_predict(ml1, x) %>%
      mutate(decile = ntile(desc(prediction), 10)) %>%
      group_by(decile) %>%
      summarize(arrdelay = mean(arrdelay)) %>%
      select(decile, arrdelay) %>%
      collect()
  })
```

```{r}
deciles <- rbind(
  data.frame(data = 'train', model_deciles$train),
  data.frame(data = 'valid', model_deciles$valid),
  make.row.names = FALSE
)
```

```{r}
# Plot average gains by predicted decile
deciles %>%
  ggplot(aes(factor(decile), arrdelay, fill = data)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  labs(title = 'Average gain by predicted decile', x = 'Decile', y = 'Minutes')
```


```{r}
data_2008 <- flights_tbl %>%
    filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance) & origin == "LAX" & (cancelled == 0)) %>%
    filter(depdelay > 15 & depdelay < 240) %>% #filter outliers
    filter(arrdelay > -60 & arrdelay < 360) %>% #filter outliers
    filter(year == 2008) %>%
    left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>% # merge by the columns
    left_join(airports_tbl, by = c("dest" = "faa")) %>% 
    select(year, month, arrdelay, depdelay, destination = dest, distance, uniquecarrier, description, tz_name, alt)


carrier = collect(carrier)
```

```{r}
data_2008
```

```{r}
carrier <- sdf_predict(ml1, data_2008) %>%
  group_by(description) %>%
  summarize(ArrivalDelay = mean(arrdelay), prediction = mean(prediction), freq = n()) %>%
  filter(freq > 100) %>% collect()

```


```{r}
# Plot actual gains and predicted gains by airline carrier
ggplot(carrier, aes(ArrivalDelay, prediction)) + 
  geom_point(alpha = 0.75, color = 'red', shape = 3) +
  geom_abline(intercept = 0, slope = 1, alpha = 0.15, color = 'blue') +
  geom_text(aes(label = substr(description, 1, 20)), size = 3, alpha = 0.75, vjust = -1) +
  labs(title='Average Arrival Delay Forecast', x = 'Actual', y = 'Predicted')
```


Data starts around 1987 first year may not have complete data. 22 years of data. 

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
out
```

Barplot of the number of data points in each year

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
out %>% ggplot(aes(x = year, y = n)) + geom_col()
```

FIT A MODEL:

Suppose we want to fit a linear regression of gain (depdelay - arrdelay) on distance, departure delay, and carriers using data from 2003-2007.

not collected because it will be huge!!
```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Filter records and create target variable 'gain'
system.time(
  model_data <- flights_tbl %>%
    filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance)) %>%
    filter(depdelay > 15 & depdelay < 240) %>% #filter outliers
    filter(arrdelay > -60 & arrdelay < 360) %>% #filter outliers
    filter(year >= 2003 & year <= 2007) %>%
    left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>% # merge by the columns
    mutate(gain = depdelay - arrdelay) %>%
    select(year, month, arrdelay, depdelay, distance, uniquecarrier, description, gain)
)
```

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
model_data
```

Get descriptive statistics: for every airline summarize gain distance depdelay

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Summarize data by carrier
model_data %>%
  group_by(uniquecarrier) %>%
  summarize(description = min(description), gain = mean(gain), 
            distance = mean(distance), depdelay = mean(depdelay)) %>%
  select(description, gain, distance, depdelay) %>%
  arrange(gain)
```

**FIT LINEAR REGRESSION**
Train a linear model
Predict time gained or lost in flight as a function of distance, departure delay, and airline carrier.

split to training and testing data

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Partition the data into training and validation sets
model_partition <- model_data %>% 
  sdf_partition(train = 0.8, valid = 0.2, seed = 5555)

# Fit a linear model on training data with gain as response
system.time(
  ml1 <- model_partition$train %>%
    ml_linear_regression(gain ~ distance + depdelay + uniquecarrier)
)

```

```{r}
# Summarize the linear model
#summary(ml1)
```

Assess model performance
Compare the model performance using the validation data.

Apply the model partition separatately on train and test data. 

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Calculate average gains by predicted decile
system.time(
  model_deciles <- lapply(model_partition, function(x) {
    sdf_predict(ml1, x) %>%
      mutate(decile = ntile(desc(prediction), 10)) %>%
      group_by(decile) %>%
      summarize(gain = mean(gain)) %>%
      select(decile, gain) %>%
      collect()
  })
)
```

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
model_deciles
```

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Create a summary dataset for plotting
deciles <- rbind(
  data.frame(data = 'train', model_deciles$train),
  data.frame(data = 'valid', model_deciles$valid),
  make.row.names = FALSE
)
deciles
```

visualize performance of the model it looks good.

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Plot average gains by predicted decile
deciles %>%
  ggplot(aes(factor(decile), gain, fill = data)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  labs(title = 'Average gain by predicted decile', x = 'Decile', y = 'Minutes')
```

Visualize predictions
Compare actual gains to predicted gains for an out of time sample.

new dataset
```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Select data from an out of time sample
data_2008 <- flights_tbl %>%
  filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance)) %>%
  filter(depdelay > 15 & depdelay < 240) %>%
  filter(arrdelay > -60 & arrdelay < 360) %>%
  filter(year == 2008) %>%
  left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>%
  mutate(gain = depdelay - arrdelay) %>%
  select(year, month, arrdelay, depdelay, distance, uniquecarrier, description, gain, origin, dest)
data_2008
```

for each airline plot the predicted vs actual values of gain. southwest and united wait.
delta is good. 

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
# Plot actual gains and predicted gains by airline carrier
ggplot(carrier, aes(gain, prediction)) + 
  geom_point(alpha = 0.75, color = 'red', shape = 3) +
  geom_abline(intercept = 0, slope = 1, alpha = 0.15, color = 'blue') +
  geom_text(aes(label = substr(description, 1, 20)), size = 3, alpha = 0.75, vjust = -1) +
  labs(title='Average Gains Forecast', x = 'Actual', y = 'Predicted')
```

```{r, evaluate = FALSE, include = FALSE, echo = FALSE}
spark_disconnect_all()
```

