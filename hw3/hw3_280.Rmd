---
title: "hw3"
author: "SarahJi"
date: "2/20/2018"
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyr)
library(dplyr)
library(readr)
library(DBI)
library(RSQLite)
library(sqldf)
library(dbplyr)
library(lubridate)
```

## Q1 LA City Employee Payroll

The `/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv` file on teaching server contains payroll information of LA City employees in years 2013-2017. It was downloaded from [LA City Controller's Office](https://controllerdata.lacity.org/Payroll/City-Employee-Payroll/pazn-qyym). Make a Shiny app to facilitate exploratory data analysis. 

1. For efficiency of the Shiny app, you should first pre-process, pare down, tidy, and save the data, e.g., as a compressed RDS file, to be used in the app.

**Answer**:
```{r}
LA_payroll = read_csv("/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv")

LA_payroll = LA_payroll %>% 
select(Year, `Department Title`, `Projected Annual Salary`, `Total Payments`, `Base Pay`, `Overtime Pay`, `Other Pay (Payroll Explorer)`)

names(LA_payroll) = c("Year", "Department_Title", "Projected_Annual_Salary", "Total_Payments", "Base_Pay", "Overtime_Pay", "Other_Pay")

LA_payroll$Projected_Annual_Salary = parse_number(LA_payroll$Projected_Annual_Salary)
LA_payroll$Total_Payments = parse_number(LA_payroll$Total_Payments)
LA_payroll$Base_Pay = parse_number(LA_payroll$Base_Pay)
LA_payroll$Overtime_Pay = parse_number(LA_payroll$Overtime_Pay)
LA_payroll$Other_Pay = parse_number(LA_payroll$Other_Pay)
LA_payroll$Department_Title = parse_factor(LA_payroll$Department_Title, levels = unique(LA_payroll$Department_Title))

#automatically compressed
saveRDS(LA_payroll, "LA_payroll.rds")
```

0. **Total payroll by LA City**. Visualize the total LA City payroll of each year, with breakdown into base pay, overtime pay, and other pay.

**Answer**:

0. **Who earned most?** Visualize the payroll information (total payment with breakdown into base pay, overtime pay, and other pay, Department, Job Title) of the top $n$ highest paid LA City employees in a specific year. User specifies $n$ (default 10) and year (default 2017).

**Answer**:

0. **Which departments earn most?** Visualize the mean or median payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ earning departments. User specifies $n$ (default 5), year (default 2017), and method (mean or median, default median).

**Answer**:

0. **Which departments cost most?** Visualize the total payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ expensive departments. User specifies $n$ (default 5) and year (default 2017).

**Answer**:

0. Visualize any other information you are interested in.

**Answer**:

0. Publish your Shiny app to <https://www.shinyapps.io> and share the link.

**Answer**:

## Q2 LA City Parking War

The SQLite database `/home/m280-data/la_parking/LA_Parking_Citations.sqlite` on teaching server contains information about parking tickets in LA City. It was downloaded from [LA Open Data Portal](https://data.lacity.org/A-Well-Run-City/Parking-Citations/wjz9-h9np). Connect to the database and answer following questions using plots and summary statistics. In this exercise, you are **not** allowed to load whole data into memory. Use the _transform in database, plot in R_ strategy.

1. How many tickets are in this data set? Which time period do these tickets span? Which years have most data?


**Answer**:
```{r}
sqlname = "/home/m280-data/la_parking/LA_Parking_Citations.sqlite"
# con = dbConnect(RSQLite::SQLite(), sqlname)
connection = dbConnect(RSQLite::SQLite(), sqlname, ":memory:")

la_sql = dplyr::tbl(connection, "latix")

number_of_tickets = collect(la_sql) %>% summarise(n = n_distinct(Ticket_number))
number_of_tickets$n

colnames(la_sql)

month = sqldf("SELECT strftime('%m',datetime(Issue_DateTime, 'unixepoch')) as Month from latix", dbname = sqlname)

day = sqldf("SELECT strftime('%d',datetime(Issue_DateTime, 'unixepoch')) as Day from latix", dbname = sqlname)

# Time Period Spanned (4/27/2010 to 12/30/2017)
sqldf("SELECT min(strftime('%Y-%m-%d', datetime(Issue_DateTime, 'unixepoch'))) as Year from latix", dbname = sqlname)

sqldf("SELECT max(strftime('%Y-%m-%d', datetime(Issue_DateTime, 'unixepoch'))) as Year from latix", dbname = sqlname)

#which year has the most tickets?
tickets_per_year = sqldf("SELECT strftime('%Y',datetime(Issue_DateTime, 'unixepoch')) as Year from latix", dbname = sqlname) %>% group_by(Year) %>% summarize(n = n())

```

0. When (which hour, weekday, month day, and month) are you most likely to get a ticket and when are you least likely to get a ticket?

**Answer**:

```{r}
#which hour are you most likely to get a ticket?
tickets_per_hour = collect(la_sql) %>% 
mutate(converted_datetime = as.POSIXct(Issue_DateTime, origin = "1970-01-01 UTC"),
Hour = hour(converted_datetime)) %>% 
group_by(Hour) %>% summarize(n = n()) %>% mutate(proportion = n / sum(n)) %>% arrange(desc(proportion))

head(tickets_per_hour, n = 24)

#which weekday are you most likely to get a ticket?
tickets_per_weekday = collect(la_sql) %>% 
mutate(converted_date = as.POSIXct(Issue_DateTime, origin = "1970-01-01 UTC"),
Weekday = weekdays(converted_date)) %>% 
group_by(Weekday) %>% summarize(n = n()) %>% mutate(proportion = n / sum(n)) %>% arrange(desc(proportion))

head(tickets_per_weekday, n = 7)

#which month are you most likely to get a ticket?
tickets_per_month = sqldf("SELECT strftime('%m',datetime(Issue_DateTime, 'unixepoch')) as Month from latix", dbname = sqlname) %>% group_by(Month) %>% summarize(n = n()) %>% mutate(proportion = n / sum(n)) %>% arrange(desc(proportion))

head(tickets_per_month, 12)

#which month day are you most likely to get a ticket?
tickets_per_monthday = sqldf("SELECT strftime('%d',datetime(Issue_DateTime, 'unixepoch')) as MonthDay from latix", dbname = sqlname) %>% group_by(MonthDay) %>% summarize(n = n()) %>% mutate(proportion = n / sum(n)) %>% arrange(desc(proportion))

head(tickets_per_monthday, 31)
```

0. Which car makes received most citations?

**Answer**:
```{r}
#which make are you most likely to get a ticket?
tickets_per_make = collect(la_sql) %>% 
group_by(Make) %>% summarize(n = n()) %>% mutate(proportion = n / sum(n)) %>% arrange(desc(proportion))

head(tickets_per_make)

```

0. How many different colors of cars were ticketed? Which color attracted most tickets?

**Answer**:
```{r}
#how many different colors of cars were ticketed?
number_of_colors = collect(la_sql) %>% summarise(n = n_distinct(Color))
number_of_colors$n

#which color attracted most tickets?
tickets_per_color = collect(la_sql) %>% 
group_by(Color) %>% summarize(n = n()) %>% mutate(proportion = n / sum(n)) %>% arrange(desc(proportion))

head(tickets_per_color)
```

0. What are the most common ticket types?

**Answer**:
```{r}
tickets_per_violationtype = collect(la_sql) %>% 
group_by(Violation_Description) %>% summarize(n = n()) %>% mutate(proportion = n / sum(n)) %>% arrange(desc(proportion))

head(tickets_per_violationtype)
```

0. How much money was collected on parking tickets in 2015 and 2016?

**Answer**:
```{r}
tickets_per_violationtype = collect(la_sql) %>% 
group_by(Violation_Description) %>% summarize(n = n()) %>% mutate(proportion = n / sum(n)) %>% arrange(desc(proportion))

head(tickets_per_violationtype)
```

0. Visualize any other information you are interested in.

**Answer**:
```{r}

```